<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki Wellness AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .chat-container {
            height: calc(100vh - 200px);
        }
        .message {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-green-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold">Ki Wellness AI</h1>
                        <p class="text-green-100">Your Health & Wellness Assistant</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Navigation -->
                        <nav class="flex items-center space-x-4">
                            <a href="/" class="px-3 py-1 bg-green-700 rounded-lg text-sm hover:bg-green-800 transition-colors">
                                <i class="fas fa-home mr-1"></i>Home
                            </a>
                            <a href="/chat" class="px-3 py-1 bg-green-800 rounded-lg text-sm hover:bg-green-900 transition-colors">
                                <i class="fas fa-comments mr-1"></i>Chat
                            </a>
                            <a href="/api-keys" class="px-3 py-1 bg-green-700 rounded-lg text-sm hover:bg-green-800 transition-colors">
                                <i class="fas fa-key mr-1"></i>API Keys
                            </a>
                            <a href="/auth/logout" class="px-3 py-1 bg-red-600 rounded-lg text-sm hover:bg-red-700 transition-colors">
                                <i class="fas fa-sign-out-alt mr-1"></i>Logout
                            </a>
                        </nav>
                        
                        <button id="statusBtn" class="px-3 py-1 bg-green-700 rounded-lg text-sm hover:bg-green-800">
                            Check Status
                        </button>
                        <button id="clearBtn" class="px-3 py-1 bg-red-600 rounded-lg text-sm hover:bg-red-700">
                            Clear Chat
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-6">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Settings Panel -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-lg font-semibold mb-4 text-gray-800">Chat Settings</h2>
                        
                        <!-- Tone Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Response Tone</label>
                            <select id="toneSelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="friendly">Friendly</option>
                                <option value="professional">Professional</option>
                                <option value="casual">Casual</option>
                                <option value="encouraging">Encouraging</option>
                                <option value="educational">Educational</option>
                            </select>
                        </div>

                        <!-- Custom Instructions -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Custom Instructions</label>
                            <textarea id="instructions" rows="3" placeholder="Add any specific instructions for the AI..." 
                                      class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                        </div>

                        <!-- Model Info -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Model Information</h3>
                            <div id="modelInfo" class="text-sm text-gray-600">
                                Loading...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="lg:col-span-3">
                    <div class="bg-white rounded-lg shadow-md">
                        <!-- Chat Messages -->
                        <div id="chatMessages" class="chat-container overflow-y-auto p-4 space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                <div class="text-4xl mb-2">ðŸ’¬</div>
                                <p>Start a conversation with Ki Wellness AI</p>
                                <p class="text-sm">Ask about health, nutrition, exercise, or wellness topics</p>
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div class="border-t border-gray-200 p-4">
                            <form id="chatForm" class="flex space-x-3">
                                <input type="text" id="messageInput" 
                                       placeholder="Type your message here..." 
                                       class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                       required>
                                <button type="submit" 
                                        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50"
                                        id="sendBtn">
                                    Send
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let isLoading = false;

        // DOM elements
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const chatMessages = document.getElementById('chatMessages');
        const sendBtn = document.getElementById('sendBtn');
        const toneSelect = document.getElementById('toneSelect');
        const instructions = document.getElementById('instructions');
        const statusBtn = document.getElementById('statusBtn');
        const clearBtn = document.getElementById('clearBtn');
        const modelInfo = document.getElementById('modelInfo');

        // Event listeners
        chatForm.addEventListener('submit', handleSubmit);
        statusBtn.addEventListener('click', checkStatus);
        clearBtn.addEventListener('click', clearChat);

        // Initialize
        checkStatus();

        async function handleSubmit(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message || isLoading) return;

            const tone = toneSelect.value;
            const customInstructions = instructions.value.trim();

            // Add user message
            addMessage('user', message);
            messageInput.value = '';
            
            // Show loading
            setLoading(true);
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        tone: tone,
                        instructions: customInstructions
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    addMessage('ai', data.response);
                } else {
                    addMessage('error', `Error: ${data.error}`);
                }
            } catch (error) {
                addMessage('error', `Network error: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        function addMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubbleClass = type === 'user' 
                ? 'bg-green-600 text-white' 
                : type === 'error' 
                ? 'bg-red-100 text-red-800' 
                : 'bg-gray-100 text-gray-800';
            
            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${bubbleClass}">
                    <div class="text-sm">${escapeHtml(content)}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function setLoading(loading) {
            isLoading = loading;
            sendBtn.disabled = loading;
            sendBtn.textContent = loading ? 'Sending...' : 'Send';
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.success) {
                    modelInfo.innerHTML = `
                        <div class="text-green-600">âœ“ ${data.model}</div>
                        <div class="text-sm">Status: ${data.status}</div>
                        <div class="text-sm">Messages: ${data.conversation_count}</div>
                    `;
                } else {
                    modelInfo.innerHTML = `
                        <div class="text-red-600">âœ— Error</div>
                        <div class="text-sm">${data.error}</div>
                    `;
                }
            } catch (error) {
                modelInfo.innerHTML = `
                    <div class="text-red-600">âœ— Connection Error</div>
                    <div class="text-sm">${error.message}</div>
                `;
            }
        }

        async function clearChat() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                try {
                    await fetch('/api/clear', { method: 'POST' });
                    chatMessages.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">ðŸ’¬</div>
                            <p>Start a conversation with Ki Wellness AI</p>
                            <p class="text-sm">Ask about health, nutrition, exercise, or wellness topics</p>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error clearing chat:', error);
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
